---
title: "Exploratory_Data_Analysis"
author: "Chance Robinson"
date: "9/21/2019"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Exploratory Data Analysis


### Library Imports

```{r libraries, quietely=TRUE, warn.conflicts=FALSE}
library(tidyverse)
# Date manipulation
library(lubridate)
# Plotting
library(olsrr)
# RMLSE
library(MLmetrics)
```

### Load the csv data


```{r load, results='hide', message=FALSE}

train <- read_csv('../../../data/train.csv')
test <- read_csv('../../../data/test.csv')

```

### Column Names (Train)

```{r column_names}

colnames(train)

```



### Example Output (Train)

```{r train}

head(train)

```

### Example output (Test)

- The test data set is missing 3 columns from the train data set (causal, registered and count)

```{r test}

head(test)

```

### Identify Dimensions

```{r echo=FALSE}
# get the dimensions of the train and test data sets

no_of_rows_trn <- dim(train)[1]
no_of_rows_tst <- dim(test)[1]

no_of_cols_trn <- dim(train)[2]
no_of_cols_tst <- dim(test)[2]

# no_of_rows_trn
# no_of_rows_tst
# 
# no_of_cols_trn
# no_of_cols_tst

```

- Train {"rows": `r no_of_rows_trn`, "columns": `r no_of_cols_trn`}

- Test {"rows": `r no_of_rows_tst`, "columns": `r no_of_cols_tst`}


### Missing Data (Both)

- No NA values can be found in either the training or test data sets 

```{r missing}

# train
any(is.na(train))

# test
any(is.na(test))

```


### Data Dictionary

  Column Name      | 	Type                Description
  -----------------|    ----------------- | ------------------------------------------------
  1.  datetime     |    Date			        | YYYY-MM-DD HH24 (example:  2011-01-01 04:00:00)
  2.  season       |    Integer 		      |	(1-4)
  3.  holiday      |    Integer 		      |	(0 or 1)
  4.  workingday   |    Integer 		      |	(0 or 1)
  5.  weather      |    Integer 		      |	(1-4)
  6.  temp         |    Float 			      |	temparture in Celcius
  7.  atemp        |    Float 			      |	"feels like" temperature in Celsius
  8.  humidity     |    Integer           | relative humidity
  9.  windspeed    |    Float             | wind speed
  10. casual       |    Integer 		      |	count of casual users 
  11. registered   |    Integer 		      |	count of registered users 
  12. count        |    Integer 		      |	count of total users `response variable`
  
  
### Factors

  * season
    + 1 = Dec 21 ~ March 20 (Spring)
    + 2 = March 21 ~ Jun 20 (Summer)
    + 3 = June 21 ~ Sept 20 (Fall)
    + 4 = Sept 21 ~ Dec 20  (Winter)

  * holiday
    + 0 = No
    + 1 = Yes
    
  * workingday
    + 0 = No
    + 1 = Yes
    
```{r factors}
train$season <- factor(train$season, labels = c("Spring", "Summer", "Fall", "Winter"))
test$season <- factor(test$season, labels = c("Spring", "Summer", "Fall", "Winter"))

table(train$season)

train$holiday <- factor(train$holiday, labels = c("No", "Yes"))
test$holiday <- factor(test$holiday, labels = c("No", "Yes"))

table(train$holiday)

train$workingday <- factor(train$workingday, labels = c("No", "Yes"))
test$workingday <- factor(test$workingday, labels = c("No", "Yes"))

table(train$workingday)

train$weather <- factor(train$weather, labels = c("Great", "Good", "Average", "Poor"))
test$weather <- factor(test$weather, labels = c("Great", "Good", "Average", "Poor"))


table(train$weather)


```



### Split Date-Time (Both)

- Year, Month, Day and Hour

```{r}

library(lubridate)

train <- train %>%
  mutate(year = as.factor(format(datetime, format = "%Y")), 
         month = as.numeric(format(datetime, format = "%m")), 
         day = as.factor(format(datetime, format = "%d")),
         hour = as.factor(format(datetime, format = "%H")))

test <- test %>%
  mutate(year = as.factor(format(datetime, format = "%Y")), 
         month = as.numeric(format(datetime, format = "%m")), 
         day = as.factor(format(datetime, format = "%d")),
         hour = as.factor(format(datetime, format = "%H")))


```



### Convert Months to Ordered Factor (Both)

```{r}

train$month <-month(train$datetime, label = TRUE, abbr = FALSE)
test$month <-month(test$datetime, label = TRUE, abbr = FALSE)

```


### Count by Month (Train)

- The months seem to show an upward trend throughout the year
- Increased popularity of Ride-Sharing program?

```{r}

train %>%
  ggplot(aes(x = month)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

### Count by Month (Test)

- Notice how the months with fewer days have fewer totals (i.e...February)


```{r}

test %>%
  ggplot(aes(x = month)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```




### Days (Train)

- The train data set covers days from the 1st through the 19th


```{r}

train %>%
  ggplot(aes(x = day)) + 
  geom_bar()

```


### Days (Test)

- The test set covers days from the 20th through the 31st

```{r days_test}


test %>%
  ggplot(aes(x = day)) + 
  geom_bar()


```

### Outlier

```{r}

# 
# outliers <- train[   train$count > median(train$count) + (sd(train$count) * 2), ]
# 
# outliers

# train <- train %>%
#   filter(!datetime %in% outliers$datetime)


## maybe remove observations where the count is more than 2-3 SDs from the mean of the month instead?

train %>%
  group_by(month) %>%
  summarize(mean = mean(count), sd = sd(count), median = median(count), count = n()) 


train1 <- train %>%
  filter(month == 'January') %>%
  filter(count > (65.0 + (95.30252 * 2))) %>%
  select(datetime)

train2 <- train %>%
  filter(month == 'February') %>%
  filter(count > (78.0 + (109.80232	* 2))) %>%
  select(datetime)

train3 <- train %>%
  filter(month == 'March') %>%
  filter(count > (100.0 + (155.35281 * 2))) %>%
  select(datetime)

train4 <- train %>%
  filter(month == 'April') %>%
  filter(count > (133.0 + (182.41762 * 2))) %>%
  select(datetime)

train5 <- train %>%
  filter(month == 'May') %>%
  filter(count > (182.0 + (189.32017 * 2))) %>%
  select(datetime)

train6 <- train %>%
  filter(month == 'June') %>%
  filter(count > (206.0 + (199.62869 * 2))) %>%
  select(datetime)

train7 <- train %>%
  filter(month == 'July') %>%
  filter(count > (209.5 + (184.85734 * 2))) %>%
  select(datetime)

train8 <- train %>%
  filter(month == 'August') %>%
  filter(count > (193.0 + (197.19846	* 2))) %>%
  select(datetime)

train9 <- train %>%
  filter(month == 'September') %>%
  filter(count > (188.0 + (208.91591 * 2))) %>%
  select(datetime)

train10 <- train %>%
  filter(month == 'October') %>%
  filter(count > (180.0 + (204.07941 * 2))) %>%
  select(datetime)

train11 <- train %>%
  filter(month == 'November') %>%
  filter(count > (162.0 + (165.42097 * 2))) %>%
  select(datetime)

train12 <- train %>%
  filter(month == 'December') %>%
  filter(count > (138.0 + (155.92605 * 2))) %>%
  select(datetime)


outliers <- rbind(train1, train2, train3, train4, train5, train6, train7, train8, train9, train10, train11, train12)

outliers

train <- train %>%
  filter(!datetime %in% outliers$datetime)


# train[5632,]
# 
# 
# train <- train %>%
#   filter(!datetime=='2012-01-09 18:00:00')

train

```


### Explanatory Variable plots against Response Variable

#### Continuous Variables

```{r}

train %>%
  ggplot(aes(x = temp, y = count)) + 
  geom_point(alpha = 0.3) + 
  scale_x_continuous(breaks = seq(from = 0, to = 45, by = 2)) + 
  geom_smooth(method = 'lm')
  

```


```{r}
train %>%
  ggplot(aes(x = windspeed, y = count)) + 
  geom_point(alpha = 0.3) + 
  scale_x_continuous(breaks = seq(from = 0, to = 45, by = 2)) + 
  geom_smooth(method = 'lm')

```

#### Categorical Variables

```{r}

train %>%
  ggplot(aes(x=season, y=count, fill=season)) + geom_boxplot()


train %>%
  ggplot(aes(x=holiday, y=count, fill=holiday)) + geom_boxplot()


train %>%
  ggplot(aes(x=workingday, y=count, fill=workingday)) + geom_boxplot()


train %>%
  ggplot(aes(x=weather, y=count, fill=weather)) + geom_boxplot()


train %>%
  ggplot(aes(x=month, y=count, fill=month)) + geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))





```


### Model Fitting


```{r}

model.base.formula = count ~ weather + 
                             windspeed + 
                             temp + 
                             month +
                             hour +
                             month:hour
  
  # datetime


model  <- lm(formula = model.base.formula, data = train)

plot(model)

summary(model)

ols_plot_resid_lev(model)

```


### RMSLE: Root Mean Squared Logarithmic Error Loss
```{r}

RMSLE(y_pred = floor(ifelse(model$fitted.values < 0, 0, model$fitted.values)), y_true = train$count)

```


```{r}

## To test in Kaggle, submit the produced "submit" file
test$count <- predict.lm(model, test)

# when less that 0, replace
test <- test %>%
  mutate(count = floor(ifelse(count < 0, 0, count)))
         
# submit <- test %>% subset(select=c(datetime, count))
# write.csv(submit, file = "./kaggle_submission.csv", row.names = F)

# Kaggle Score:  RMSLE = 0.89888
score = (1 - (2722 / 3246)) * 100

score
```





