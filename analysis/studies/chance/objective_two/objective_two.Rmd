---
title: "Objective 2 Analysis"
author: "Chance Robinson"
date: "9/27/2019"
output: 
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Exploratory Data Analysis


### Library Imports

```{r libraries, quietely=TRUE, message = FALSE, echo = FALSE, warn.conflicts=FALSE}
library(tidyverse)
# Date manipulation
library(lubridate)
# RMLSE
library(MLmetrics)
# Time Series Analysis
library(tseries)
library(forecast)
```

### Load the csv data


```{r load, results='hide', message=FALSE}

train <- read_csv('../../../data/train.csv')
test <- read_csv('../../../data/test.csv')

```


    
```{r factors}
train$season <- factor(train$season, labels = c("Spring", "Summer", "Fall", "Winter"))
test$season <- factor(test$season, labels = c("Spring", "Summer", "Fall", "Winter"))

table(train$season)

train$holiday <- factor(train$holiday, labels = c("No", "Yes"))
test$holiday <- factor(test$holiday, labels = c("No", "Yes"))

table(train$holiday)

train$workingday <- factor(train$workingday, labels = c("No", "Yes"))
test$workingday <- factor(test$workingday, labels = c("No", "Yes"))

table(train$workingday)

train$weather <- factor(train$weather, labels = c("Great", "Good", "Average", "Poor"))
test$weather <- factor(test$weather, labels = c("Great", "Good", "Average", "Poor"))

table(train$weather)


```



### Split Date-Time (Both)

- Year, Month, Day and Hour

```{r}

# library(lubridate)

train <- train %>%
  mutate(year = as.factor(format(datetime, format = "%Y")), 
         month = as.numeric(format(datetime, format = "%m")), 
         day = as.factor(format(datetime, format = "%d")),
         hour = as.factor(format(datetime, format = "%H")))

test <- test %>%
  mutate(year = as.factor(format(datetime, format = "%Y")), 
         month = as.numeric(format(datetime, format = "%m")), 
         day = as.factor(format(datetime, format = "%d")),
         hour = as.factor(format(datetime, format = "%H")))


```


### Convert Months to Ordered Factor (Both)

```{r}

train$month <-month(train$datetime, label = TRUE, abbr = FALSE)
test$month <-month(test$datetime, label = TRUE, abbr = FALSE)


```



#### Modeling

    - psuedo code

    - Loop through years (train and test)

    - Loop through months (train and test)

    - fit AR model

    - Forcast x number of observations based on nrow from test dataframe and impute the count from the time series forecast
    

## 2011

### January


#### Auto Arima


```{r}

train1arm <- train %>%
  filter(year == '2011' & month == 'January') %>%
  select(datetime, count)

test1arm <- test %>%
  filter(year == '2011' & month == 'January') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train1arm$count = log(train1arm$count)

# head(train25)
# head(test25)

autoarm <- auto.arima(train1arm$count, D=1)

# ?auto.arima

number = nrow(test1arm)

acf(autoarm$residuals)
pacf(autoarm$residuals)

checkresiduals(autoarm)

fcst <- forecast(autoarm, h=number)

autoplot(fcst)

# point estimate (mean)
test1arm$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train1arm$count)

summary(autoarm)


```

#### AR 25

```{r}

train1 <- train %>%
  filter(year == '2011' & month == 'January') %>%
  select(datetime, count)

test1 <- test %>%
  filter(year == '2011' & month == 'January') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train1$count = log(train1$count)

# head(train1)
# head(test1)

AR25 <- arima(train1$count,order=c(25,0,0))

number = nrow(test1)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test1$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train1$count)
summary(AR25)

```

### February

```{r}


train2 <- train %>%
  filter(year == '2011' & month == 'February') %>%
  select(datetime, count)

test2 <- test %>%
  filter(year == '2011' & month == 'February') %>%
  mutate(count = NA) %>%
  select(datetime, count)

### Log the response variable
train2$count = log(train2$count)

# head(train2)
# head(test2)

AR25 <- arima(train2$count,order=c(25,0,0))

number = nrow(test2)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test2$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train2$count)


```


### March

```{r}


train3 <- train %>%
  filter(year == '2011' & month == 'March') %>%
  select(datetime, count)

test3 <- test %>%
  filter(year == '2011' & month == 'March') %>%
  mutate(count = NA) %>%
  select(datetime, count)

### Log the response variable
train3$count = log(train3$count)

# head(train3)
# head(test3)

AR25 <- arima(train3$count,order=c(25,0,0))

number = nrow(test3)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test3$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train3$count)

```


### April

```{r}


train4 <- train %>%
  filter(year == '2011' & month == 'April') %>%
  select(datetime, count)

test4 <- test %>%
  filter(year == '2011' & month == 'April') %>%
  mutate(count = NA) %>%
  select(datetime, count)

### Log the response variable
train4$count = log(train4$count)

# head(train4)
# head(test4)

AR25 <- arima(train4$count,order=c(25,0,0))

number = nrow(test4)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test4$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train4$count)


```


### May

```{r}


train5 <- train %>%
  filter(year == '2011' & month == 'May') %>%
  select(datetime, count)

test5 <- test %>%
  filter(year == '2011' & month == 'May') %>%
  mutate(count = NA) %>%
  select(datetime, count)

### Log the response variable
train5$count = log(train5$count)

# head(train5)
# head(test5)

AR25 <- arima(train5$count,order=c(25,0,0))
# tsdisplay(residuals(AR25),lag.max=25,main="AR(24) Resid. Diagnostics")

number = nrow(test5)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test5$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train5$count)

```

### June

```{r}


train6 <- train %>%
  filter(year == '2011' & month == 'June') %>%
  select(datetime, count)

test6 <- test %>%
  filter(year == '2011' & month == 'June') %>%
  mutate(count = NA) %>%
  select(datetime, count)

### Log the response variable
train6$count = log(train6$count)

# head(train6)
# head(test6)

AR25 <- arima(train6$count,order=c(25,0,0))
# tsdisplay(residuals(AR25),lag.max=25,main="AR(24) Resid. Diagnostics")

number = nrow(test6)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test6$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train6$count)

```

### July

```{r}


train7 <- train %>%
  filter(year == '2011' & month == 'July') %>%
  select(datetime, count)

test7 <- test %>%
  filter(year == '2011' & month == 'July') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train7$count = log(train7$count)

# head(train7)
# head(test7)

AR25 <- arima(train7$count,order=c(25,0,0))

number = nrow(test7)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test7$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train7$count)

```


### August

```{r}

train8 <- train %>%
  filter(year == '2011' & month == 'August') %>%
  select(datetime, count)

test8 <- test %>%
  filter(year == '2011' & month == 'August') %>%
  mutate(count = NA) %>%
  select(datetime, count)



### Log the response variable
train8$count = log(train8$count)

# head(train8)
# head(test8)

AR25 <- arima(train8$count,order=c(25,0,0))

number = nrow(test8)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test8$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train8$count)

```


### September

```{r}

train9 <- train %>%
  filter(year == '2011' & month == 'September') %>%
  select(datetime, count)

test9 <- test %>%
  filter(year == '2011' & month == 'September') %>%
  mutate(count = NA) %>%
  select(datetime, count)



### Log the response variable
train9$count = log(train9$count)

# head(train9)
# head(test9)

AR25 <- arima(train9$count,order=c(25,0,0))

number = nrow(test9)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test9$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train9$count)

```


### October

```{r}

train10 <- train %>%
  filter(year == '2011' & month == 'October') %>%
  select(datetime, count)

test10 <- test %>%
  filter(year == '2011' & month == 'October') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train10$count = log(train10$count)

# head(train10)
# head(test10)

AR25 <- arima(train10$count,order=c(25,0,0))

number = nrow(test10)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test10$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train10$count)

```



### November

```{r}

train11 <- train %>%
  filter(year == '2011' & month == 'November') %>%
  select(datetime, count)

test11 <- test %>%
  filter(year == '2011' & month == 'November') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train11$count = log(train11$count)

# head(train11)
# head(test11)

AR25 <- arima(train11$count,order=c(25,0,0))

number = nrow(test11)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test11$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train11$count)
```


### December

```{r}

train12 <- train %>%
  filter(year == '2011' & month == 'December') %>%
  select(datetime, count)

test12 <- test %>%
  filter(year == '2011' & month == 'December') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train12$count = log(train12$count)

# head(train12)
# head(test12)

AR25 <- arima(train12$count,order=c(25,0,0))

number = nrow(test12)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test12$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train12$count)

```


## 2012

### January


```{r}

train13 <- train %>%
  filter(year == '2012' & month == 'January') %>%
  select(datetime, count)

test13 <- test %>%
  filter(year == '2012' & month == 'January') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train13$count = log(train13$count)

# head(train13)
# head(test13)

AR25 <- arima(train13$count,order=c(25,0,0))

number = nrow(test13)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test13$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train13$count)

```

### February

```{r}


train14 <- train %>%
  filter(year == '2012' & month == 'February') %>%
  select(datetime, count)

test14 <- test %>%
  filter(year == '2012' & month == 'February') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train14$count = log(train14$count)

# head(train14)
# head(test14)

AR25 <- arima(train14$count,order=c(25,0,0))

number = nrow(test14)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test14$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train14$count)


```


### March

```{r}


train15 <- train %>%
  filter(year == '2012' & month == 'March') %>%
  select(datetime, count)

test15 <- test %>%
  filter(year == '2012' & month == 'March') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train15$count = log(train15$count)

# head(train15)
# head(test15)

AR25 <- arima(train15$count,order=c(25,0,0))

number = nrow(test15)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test15$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train15$count)


```


### April

```{r}


train16 <- train %>%
  filter(year == '2012' & month == 'April') %>%
  select(datetime, count)

test16 <- test %>%
  filter(year == '2012' & month == 'April') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train16$count = log(train16$count)

# head(train16)
# head(test16)

AR25 <- arima(train16$count,order=c(25,0,0))

number = nrow(test16)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test16$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train16$count)

```


### May

```{r}


train17 <- train %>%
  filter(year == '2012' & month == 'May') %>%
  select(datetime, count)

test17 <- test %>%
  filter(year == '2012' & month == 'May') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train17$count = log(train17$count)

# head(train17)
# head(test17)

AR25 <- arima(train17$count,order=c(25,0,0))

number = nrow(test17)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test17$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train17$count)

```

### June

```{r}


train18 <- train %>%
  filter(year == '2012' & month == 'June') %>%
  select(datetime, count)

test18 <- test %>%
  filter(year == '2012' & month == 'June') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train18$count = log(train18$count)

# head(train18)
# head(test18)

AR25 <- arima(train18$count,order=c(25,0,0))

number = nrow(test18)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test18$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train18$count)

```

### July

```{r}


train19 <- train %>%
  filter(year == '2012' & month == 'July') %>%
  select(datetime, count)

test19 <- test %>%
  filter(year == '2012' & month == 'July') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train19$count = log(train19$count)

# head(train19)
# head(test19)

AR25 <- arima(train19$count,order=c(25,0,0))

number = nrow(test19)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test19$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train19$count)

```


### August

```{r}

train20 <- train %>%
  filter(year == '2012' & month == 'August') %>%
  select(datetime, count)

test20 <- test %>%
  filter(year == '2012' & month == 'August') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train20$count = log(train20$count)

# head(train20)
# head(test20)

AR25 <- arima(train20$count,order=c(25,0,0))

number = nrow(test20)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test20$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train20$count)

```


### September

```{r}

train21 <- train %>%
  filter(year == '2012' & month == 'September') %>%
  select(datetime, count)

test21 <- test %>%
  filter(year == '2012' & month == 'September') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train21$count = log(train21$count)

# head(train21)
# head(test21)

AR25 <- arima(train21$count,order=c(25,0,0))

number = nrow(test21)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test21$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train21$count)

```


### October

```{r}

train22 <- train %>%
  filter(year == '2012' & month == 'October') %>%
  select(datetime, count)

test22 <- test %>%
  filter(year == '2012' & month == 'October') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train22$count = log(train22$count)

# head(train22)
# head(test22)

AR25 <- arima(train22$count,order=c(25,0,0))

number = nrow(test22)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test22$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train22$count)

```



### November

```{r}

train23 <- train %>%
  filter(year == '2012' & month == 'November') %>%
  select(datetime, count)

test23 <- test %>%
  filter(year == '2012' & month == 'November') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train23$count = log(train23$count)

# head(train23)
# head(test23)

AR25 <- arima(train23$count,order=c(25,0,0))
# tsdisplay(residuals(AR25),lag.max=25,main="AR(24) Resid. Diagnostics")

number = nrow(test23)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test23$count <- fcst$mean

RMSLE(y_pred = fcst$fitted, y_true = train23$count)

```


### December

```{r}

train24 <- train %>%
  filter(year == '2012' & month == 'December') %>%
  select(datetime, count)

test24 <- test %>%
  filter(year == '2012' & month == 'December') %>%
  mutate(count = NA) %>%
  select(datetime, count)


### Log the response variable
train24$count = log(train24$count)

# head(train24)
# head(test24)

AR25 <- arima(train24$count,order=c(25,0,0))

number = nrow(test24)

acf(AR25$residuals)
pacf(AR25$residuals)

checkresiduals(AR25)

fcst <- forecast(AR25, h=number)

autoplot(fcst)

# point estimate (mean)
test24$count <- fcst$mean


RMSLE(y_pred = fcst$fitted, y_true = train24$count)

summary(AR25)

```



### Combine all of the individual data frames


```{r warning = FALSE}
combined <- data.frame(datetime=character(),
                 count=double(), 
                 stringsAsFactors=FALSE) 



combined <- bind_rows(test1, test2, test3, test4, test5, test6, test7, test8, test9, test10, test11, test12,
                      test13, test14, test15, test16, test17, test18, test19, test20, test21, test22, test23, test24)


combined <- combined %>%
  mutate(count = round(exp(count)))


# combined
# write.csv(combined, file = "C:\\Users\\Chance\\Desktop\\ts_kaggle_submission.csv", row.names = F)

```


## Submit

```{r}

# Kaggle Score:  RMSLE = 1.01847
score = (1 - (2776 / 3246)) * 100

# We only beat ~14% of all submissions
score

```



